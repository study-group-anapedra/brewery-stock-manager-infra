AWSTemplateFormatVersion: "2010-09-09"
Description: Modulo RDS Aurora PostgreSQL - Versao Final para Entrega

Parameters:
  ProjectName:
    Type: String
  Environment:
    Type: String
  DBUsername:
    Type: String
  DBPassword:
    Type: String
    NoEcho: true
  DBName:
    Type: String
  DBInstanceClass:
    Type: String

Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets privadas para Aurora
      SubnetIds:
        - Fn::ImportValue: !Sub "${ProjectName}-vpc-${Environment}-private-db-az1"
        - Fn::ImportValue: !Sub "${ProjectName}-vpc-${Environment}-private-db-az2"

  DBCluster:
    Type: AWS::RDS::DBCluster
    DependsOn: DBSubnetGroup
    Properties:
      DBClusterIdentifier: !Sub "${ProjectName}-${Environment}-cluster-v2"
      Engine: aurora-postgresql
      EngineVersion: "15.8"
      DatabaseName: !Ref DBName
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref DBSubnetGroup

      # Usa exclusivamente o SG do banco criado na stack de SG
      VpcSecurityGroupIds:
        - Fn::ImportValue: !Sub "${ProjectName}-${Environment}-DbSG"

      StorageEncrypted: true
      PubliclyAccessible: false

  DBInstance:
    Type: AWS::RDS::DBInstance
    DependsOn: DBCluster
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      EngineVersion: "15.8"
      PubliclyAccessible: false

Outputs:
  DBEndpoint:
    Value: !GetAtt DBCluster.Endpoint.Address
    Export:
      Name: !Sub "${ProjectName}-${Environment}-DBEndpoint"
