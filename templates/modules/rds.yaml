AWSTemplateFormatVersion: "2010-09-09"
Description: Modulo RDS Aurora PostgreSQL

Parameters:
  ProjectName: { Type: String }
  Environment: { Type: String }
  DBUsername: { Type: String }
  DBPassword: { Type: String, NoEcho: true }
  DBName: { Type: String }
  DBInstanceClass: { Type: String }

Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets privadas para Aurora
      # CORREÇÃO: Nomes batendo com o Export do vpc.yaml
      SubnetIds:
        - Fn::ImportValue: !Sub "${ProjectName}-${Environment}-AppSubnet1"
        - Fn::ImportValue: !Sub "${ProjectName}-${Environment}-DbSubnet1"

  DBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Sub "${ProjectName}-${Environment}-aurora-cluster"
      Engine: aurora-postgresql
      EngineVersion: "15.8"
      DatabaseName: !Ref DBName
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref DBSubnetGroup
      VpcSecurityGroupIds:
        # CORREÇÃO: Nome batendo com o Export do security-group.yaml
        - Fn::ImportValue: !Sub "${ProjectName}-${Environment}-DbSG"
      StorageEncrypted: true
      BackupRetentionPeriod: 1
      PreferredBackupWindow: "03:00-04:00"

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-${Environment}-instance-1"
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      EngineVersion: "15.8"
      PubliclyAccessible: false

Outputs:
  DBEndpoint:
    Value: !GetAtt DBCluster.Endpoint.Address
    Export:
      Name: !Sub "${ProjectName}-${Environment}-DBEndpoint"