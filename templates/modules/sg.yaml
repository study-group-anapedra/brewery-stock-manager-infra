AWSTemplateFormatVersion: "2010-09-09"
Description: Security Groups base para aplicacao monolitica - Versao ASCII

Parameters:
  ProjectName: { Type: String }
  Environment: { Type: String }
  VpcId: { Type: String }

Resources:
  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      # Removido acento de 'trafego' para evitar erro ASCII
      GroupDescription: Permite trafego HTTP e HTTPS da Internet para o ALB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Permite trafego apenas do ALB na porta 8080
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref AlbSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Regras de acesso ao Banco de Dados
      VpcId: !Ref VpcId

  # Regra de entrada separada para evitar dependencia circular [cite: 2025-12-23]
  DbIngressFromApp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: Permite conexao PostgreSQL vinda da App
      GroupId: !Ref DbSecurityGroup
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref AppSecurityGroup

Outputs:
  AlbSecurityGroup:
    Value: !Ref AlbSecurityGroup
    Export: { Name: !Sub "${ProjectName}-${Environment}-AlbSG" }
  AppSecurityGroup:
    Value: !Ref AppSecurityGroup
    Export: { Name: !Sub "${ProjectName}-${Environment}-AppSG" }
  DbSecurityGroup:
    Value: !Ref DbSecurityGroup
    Export: { Name: !Sub "${ProjectName}-${Environment}-DbSG" }