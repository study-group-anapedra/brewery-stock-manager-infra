name: Deploy Master Infrastructure

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  S3_BUCKET: stock-manager-prod-artifacts
  STACK_NAME_INFRA: stock-manager-master-dev
  STACK_NAME_DNS: stock-manager-dns-dev
  DOMAIN_NAME: api.asantanadev.com 
  ENVIRONMENT: dev
  PROJECT_NAME: stock-manager

jobs:
  deploy-infra:
    name: Deploy Base Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload Modules to S3
        run: aws s3 sync templates/modules s3://${{ env.S3_BUCKET }}/modules

      - name: CloudFormation Package
        run: |
          aws cloudformation package \
            --template-file templates/master.yaml \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --output-template-file packaged-master.yaml

      - name: Deploy Master Stack
        run: |
          aws cloudformation deploy \
            --template-file packaged-master.yaml \
            --stack-name ${{ env.STACK_NAME_INFRA }} \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --parameter-overrides \
              Environment=${{ env.ENVIRONMENT }} \
              ProjectName=${{ env.PROJECT_NAME }} \
              DomainName=${{ env.DOMAIN_NAME }} \
              CertificateARN=${{ vars.CERTIFICATE_ARN }} \
              LatestAMIId=${{ vars.LATEST_AMI }} \
              KeyName=${{ vars.KEY_NAME }} \
              HostedZoneId=${{ vars.HOSTED_ZONE_ID }} \
              DBUsername=${{ secrets.DB_USERNAME }} \
              DBPassword=${{ secrets.DB_PASSWORD }} \
              WebInstanceType=t3.micro \
              AppInstanceType=t3.small \
              DBInstanceClass=db.t3.micro

  deploy-dns:
    name: Deploy DNS Records
    runs-on: ubuntu-latest
    needs: deploy-infra
    env:
      HOSTED_ZONE_ID_VAL: ${{ vars.HOSTED_ZONE_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Route53 Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/modules/route53.yaml \
            --stack-name ${{ env.STACK_NAME_DNS }} \
            --parameter-overrides \
              DomainName=${{ env.DOMAIN_NAME }} \
              HostedZoneId=${{ env.HOSTED_ZONE_ID_VAL }} \
              ParentStackName=${{ env.STACK_NAME_INFRA }}