name: Deploy Infrastructure (VPC -> Master -> DNS)

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  S3_BUCKET: stock-manager-prod-artifacts
  STACK_NAME_VPC: stock-manager-vpc-prod
  STACK_NAME_INFRA: stock-manager-master-prod
  STACK_NAME_DNS: stock-manager-dns-prod

jobs:
  # ==================================================
  # JOB 1: Fundação de Rede (VPC e NAT Gateway)
  # ==================================================
  deploy-vpc:
    name: Deploy VPC Foundation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy VPC stack
        run: |
          aws cloudformation deploy \
            --template-file templates/modules/vpc.yaml \
            --stack-name ${{ env.STACK_NAME_VPC }} \
            --parameter-overrides file://environments/prod/parameters-vpc-prod.json

  # ==================================================
  # JOB 2: Infraestrutura Master (RDS, ALB, Redis, ASG)
  # ==================================================
  deploy-infra:
    name: Deploy Master Infrastructure
    runs-on: ubuntu-latest
    needs: deploy-vpc
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload CloudFormation modules to S3
        run: |
          aws s3 sync templates/modules s3://${{ env.S3_BUCKET }}/modules

      - name: Package master template
        run: |
          aws cloudformation package \
            --template-file templates/master.yaml \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --output-template-file packaged-master.yaml

      - name: Deploy master stack
        run: |
          aws cloudformation deploy \
            --template-file packaged-master.yaml \
            --stack-name ${{ env.STACK_NAME_INFRA }} \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --parameter-overrides \
              ProjectName=stock-manager \
              Environment=prod \
              DomainName=api.asantanadev.com \
              HostedZoneId=Z0620408R15AZPT367P2 \
              CertificateARN=arn:aws:acm:us-east-1:365646127398:certificate/63e80d1b-c0cc-402b-a280-409296304096 \
              LatestAMIId=ami-0c101f26f147fa7fd \
              KeyName=chave-estoque-prod \
              AppInstanceType=t3.small \
              DBInstanceClass=db.t4g.medium \
              DBName=stockmanagerprod \
              DBUsername=${{ secrets.DB_USERNAME }} \
              DBPassword=${{ secrets.DB_PASSWORD }}

  # ==================================================
  # JOB 3: DNS e Route53
  # ==================================================
  deploy-dns:
    name: Deploy Route53 DNS
    runs-on: ubuntu-latest
    needs: deploy-infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy DNS stack
        run: |
          aws cloudformation deploy \
            --template-file templates/modules/route53-records.yaml \
            --stack-name ${{ env.STACK_NAME_DNS }} \
            --parameter-overrides \
              ProjectName=stock-manager \
              Environment=prod \
              DomainName=api.asantanadev.com \
              HostedZoneId=Z0620408R15AZPT367P2