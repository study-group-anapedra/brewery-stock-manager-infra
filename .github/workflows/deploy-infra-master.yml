name: Deploy Infrastructure (Foundation → Core → Compute → Monitoring → DNS)

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  S3_BUCKET: stock-manager-prod-artifacts
  STACK_FOUNDATION: stock-manager-foundation-prod
  STACK_CORE: stock-manager-core-prod
  STACK_COMPUTE: stock-manager-compute-prod
  STACK_MONITORING: stock-manager-monitoring-prod
  STACK_DNS: stock-manager-dns-prod

jobs:
# ==================================================
# JOB 1 - FOUNDATION
# ==================================================
  deploy-foundation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload modules to S3
        run: aws s3 sync templates/modules s3://${{ env.S3_BUCKET }}/modules

      - name: Deploy Foundation
        run: |
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' environments/prod/parameters-foundation-prod.json)
          aws cloudformation deploy \
            --template-file templates/foundation.yaml \
            --stack-name ${{ env.STACK_FOUNDATION }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides "$PARAMS"

# ==================================================
# JOB 2 - CORE  (corrigido com envsubst)
# ==================================================
  deploy-core:
    runs-on: ubuntu-latest
    needs: deploy-foundation
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Prepare core parameters with secrets and variables
        run: |
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export CERTIFICATE_ARN="${{ vars.CERTIFICATE_ARN }}"

          envsubst < environments/prod/parameters-core-prod.json > parameters-core-final.json

          echo "Parameters after substitution:"
          cat parameters-core-final.json

      - name: Deploy Core
        run: |
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters-core-final.json)
          aws cloudformation deploy \
            --template-file templates/core.yaml \
            --stack-name ${{ env.STACK_CORE }} \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --parameter-overrides "$PARAMS" ArtifactsBucket=${{ env.S3_BUCKET }}

# ==================================================
# JOB 3 - COMPUTE
# ==================================================
  deploy-compute:
    runs-on: ubuntu-latest
    needs: deploy-core
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Prepare parameters with secrets and variables
        run: |
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export KEY_NAME="${{ vars.KEY_NAME }}"
          export LATEST_AMI="${{ vars.LATEST_AMI }}"

          envsubst < environments/prod/parameters-compute-prod.json > parameters-compute-final.json

          echo "Parameters after substitution:"
          cat parameters-compute-final.json

      - name: Deploy Compute
        run: |
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters-compute-final.json)
          aws cloudformation deploy \
            --template-file templates/compute.yaml \
            --stack-name ${{ env.STACK_COMPUTE }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides "$PARAMS" ArtifactsBucket=${{ env.S3_BUCKET }}

# ==================================================
# JOB 4 - MONITORING
# ==================================================
  deploy-monitoring:
    runs-on: ubuntu-latest
    needs: deploy-compute
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Monitoring
        run: |
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' environments/prod/parameters-monitoring-prod.json)
          aws cloudformation deploy \
            --template-file templates/monitoring.yaml \
            --stack-name ${{ env.STACK_MONITORING }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides "$PARAMS" ArtifactsBucket=${{ env.S3_BUCKET }}

# ==================================================
# JOB 5 - DNS
# ==================================================
  deploy-dns:
    runs-on: ubuntu-latest
    needs: deploy-monitoring
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy DNS
        run: |
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' environments/prod/parameters-dns-prod.json)
          aws cloudformation deploy \
            --template-file templates/modules/route53-records.yaml \
            --stack-name ${{ env.STACK_DNS }} \
            --parameter-overrides "$PARAMS"
